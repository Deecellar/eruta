#!/usr/bin/env ruby

fin       = File.open(ARGV[0], 'rt')
inproto   = nil;
instruct  = nil;
incomm    = nil; 
STRUCT_RE = %r{struct ([A-Za-z0-9]+\_)}
COMM_RE   = %r(\/\*\*)
FUNC_RE   = %r(\{)
COMMEND_RE= %r(\*\*\/)
macro     =  File.basename(ARGV[0]).gsub('.c', '_PROTO_H').upcase
puts "#ifndef #{macro}"
puts "#define #{macro}"
puts "/*\nThis file was autogenerated from #{ARGV[0]}\nby bin/genproto on #{Time.now}\nPlease do not hand edit.\n*/\n\n"
fin.each_line do |line|
  if incomm
    commend = line.match(COMMEND_RE)
    done    = line.match(FUNC_RE)
    struct  = line.match(STRUCT_RE)    
    if struct
      name = struct[1].chop # remove _
      puts "struct #{name}_;"
      puts "typedef struct #{name}_ #{name};"
    else
      if done
        if commend
          puts line
        else  
          puts line.gsub(/[ ]*{/, ';')
          puts 
        end
      else
        printf line
      end
    end
    if done
      incomm = nil
    end
  else
     incomm = line.match(COMM_RE)
     if incomm
      printf(line)
     end
  end  
end

puts "#endif // #{macro}"
puts
